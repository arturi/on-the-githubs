#!/usr/bin/env node
var onTheGithubs = require('..');
var cli          = require('cli').enable('status', 'help', 'version', 'timeout');

cli.parse({
  repo: ['r', 'Repository', 'string'],
  user: ['u', 'User / Organisation', 'string'],
  format: ['f', 'Format', 'string', 'html'],
  output: ['o', 'Output', 'string', '-']
});

cli.main(function(args, options) {
  if (!options.repo) {
    this.fatal('Please specify a repository. Use -h for help. ');
  }
  if (!options.user) {
    this.fatal('Please specify a organisation. Use -h for help. ');
  }

  var config = {
    service: 'https://api.github.com',
    paginate: true,
    concurrency: 6,
    squash: true,
    userpaths: {
      contributors: [
        // '/orgs/{user}/members',
        '/repos/{user}/{repo}/contributors',
        '/repos/{user}/{repo}/collaborators'
      ],
      collaborators: [
        '/repos/{user}/{repo}/issues/comments',
        '/repos/{user}/{repo}/issues'
      ],
      watchers: [
        '/repos/{user}/{repo}/subscribers',
        '/repos/{user}/{repo}/stargazers'
      ]
    }
  };

  config.user = options.user;
  config.repo = options.repo;

  var agg = onTheGithubs.aggregate(cli, config);
  agg.execute(function (err, users) {
    if (err) {
      return cli.error(err);
    }

    // Display users
    for (var type in users) {
      cli.ok(type);
      for (var i in users[type]) {
        cli.ok('  ' + users[type][i].login);
      }
    }
    cli.ok('Done.');
  });
});
