#!/usr/bin/env node
var onTheGithubs = require('..');
var cli          = require('cli').enable('status', 'help', 'version', 'timeout');

cli.parse({
  repo: ['r', 'Repositories (comma separated)', 'string'],
  user: ['u', 'User / Organisation', 'string'],
  format: ['f', 'Format', ['html', 'json'], 'html'],
  output: ['o', 'Output', 'path', '-'],
  tag: ['t', 'Tag to replace in an existing html output file. E.g. {{ghcommunity}}', 'string', ''],
  concurrency: ['c', 'Concurrency. Higher than 1 may change order within user categories.', 'int', 1]
});

cli.main(function(args, options) {
  if (!options.repo) {
    this.fatal('Please specify a repository. Use -h for help. ');
  }
  if (!options.user) {
    this.fatal('Please specify a user/organisation. Use -h for help. ');
  }

  var config = {
    service: 'https://api.github.com',
    paginate: true,
    concurrency: 1,
    squash: true,
    descriptions: {
      contributors: 'People coding',
      collaborators: 'People commenting',
      watchers: 'People watching'
    },
    userpaths: {
      contributors: [
        // '/orgs/{user}/members',
        '/repos/{user}/{repo}/contributors',
        '/repos/{user}/{repo}/collaborators'
      ],
      collaborators: [
        '/repos/{user}/{repo}/issues/comments',
        '/repos/{user}/{repo}/issues'
      ],
      watchers: [
        '/repos/{user}/{repo}/subscribers',
        '/repos/{user}/{repo}/stargazers'
      ]
    }
  };

  config.user        = options.user;
  config.repo        = options.repo;
  config.concurrency = options.concurrency;

  var agg = onTheGithubs.aggregate(cli, config);
  agg.execute(function (err, users) {
    if (err) {
      return cli.error(err);
    }

    // Format
    var out = '';
    if (options.format === 'json') {
      out = users.toString();
    } else if (options.format === 'html') {
      for (var type in users) {
        out += '<div class="on-the-githubs-community">' + "\n";
        if (users[type].length) {
          out += "  " + '<h2>' + type + ' (' + users[type].length + ')</h2>' + "\n";
          if (config.descriptions && config.descriptions[type]) {
            out += "  " + '<p>' + config.descriptions[type] + '</p>' + "\n";
          }
          for (var i in users[type]) {
            out += "  " + '<a target="_blank" rel="tooltip" data-placement="bottom" title="' + users[type][i].login + '" href="' + users[type][i].html_url + '">';
            out += '<img src="' + users[type][i].avatar_url + '&s=64" />';
            out += '</a>' + "\n";
          }
        }
        out += '</div>' + "\n";
      }
    } else {
      return cli.error('Unsupported format: ' + options.format);
    }

    // Output
    if (options.output === '-') {
      cli.output(out);
    } else {
      if (options.tag) {
        if (!cli.native.fs.existsSync(options.output)) {
          return cli.error('Instructed to replace ' + options.tag + ' in ' + options.output + ' but it does not exist');
        }
        var buf = cli.native.fs.readFileSync(options.output);
        out = (buf+'').replace(options.tag, out);
      }

      cli.native.fs.writeFileSync(options.output, out);
    }
  });
});
